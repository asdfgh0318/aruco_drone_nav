<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArUco Vision GPS - Documentation</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav>
        <div class="container">
            <a href="index.html" class="logo">ArUco<span>Nav</span></a>
            <ul>
                <li><a href="index.html" class="active">Home</a></li>
                <li><a href="gui-guide.html">Debug GUI</a></li>
                <li><a href="calibration.html">Calibration</a></li>
                <li><a href="sitl.html">SITL Testing</a></li>
                <li><a href="https://github.com/asdfgh0318/aruco_drone_nav">GitHub</a></li>
            </ul>
        </div>
    </nav>

    <div class="hero">
        <h1>ArUco Vision GPS</h1>
        <p>Vision-based GPS emulator for indoor drones using ceiling-mounted ArUco markers on Raspberry Pi Zero 2W</p>
    </div>

    <main>
        <h2>Overview</h2>
        <p>This system enables autonomous indoor drone flight by replacing GPS with ceiling-mounted ArUco markers. A Raspberry Pi Zero 2W detects the markers using CLAHE preprocessing, calculates the drone's world-frame position, and sends <code>VISION_POSITION_ESTIMATE</code> to the flight controller via MAVLink. The FC handles all navigation, PID, missions, and failsafes natively.</p>

        <h2>Current Performance (RPi Zero 2W)</h2>
        <table>
            <tr>
                <th>Metric</th>
                <th>Value</th>
            </tr>
            <tr>
                <td>Resolution</td>
                <td>1280x720 (MJPG)</td>
            </tr>
            <tr>
                <td>Detection Rate</td>
                <td>95-100%</td>
            </tr>
            <tr>
                <td>Processing Time</td>
                <td>~270ms/frame</td>
            </tr>
            <tr>
                <td>FPS</td>
                <td>~3.7</td>
            </tr>
            <tr>
                <td>Marker Type</td>
                <td>Single ArUco (DICT_4X4_50)</td>
            </tr>
            <tr>
                <td>Marker Size</td>
                <td>18cm (A4 printable)</td>
            </tr>
        </table>

        <h3>Timing Breakdown</h3>
        <pre><code>grab:0ms  gray:3ms  CLAHE:20ms  bgr:2ms  detect:250ms  total:275ms</code></pre>

        <h2>System Architecture</h2>
        <div class="diagram">
<pre>
  Ceiling
  [Marker 0] [Marker 1] [Marker 2] ...    (known world positions)
       |          |          |
       v          v          v
  +-----------------------------+          +---------------------+
  | RPi Zero 2W                 |          | Flight Controller   |
  |                             |          | ArduCopter          |
  |  USB Camera (1280x720 MJPG) |          |                     |
  |       |                     |          | EKF3                |
  |       v                     |          |  - ExternalNav src  |
  |  CLAHE Preprocessing        |          |  - Baro for alt     |
  |       |                     |          |                     |
  |       v                     |  UART   | PID / Navigation    |
  |  ArUco Detection            | -------> | Missions / RTL      |
  |  - detectMarkers()          | MAVLink  | Failsafes           |
  |  - solvePnP per marker      |          +---------------------+
  |       |                     |
  |       v                     |
  |  Position Estimation        |
  |  - marker-to-world transform|
  |  - ENU to NED conversion    |
  |       |                     |
  |       v                     |
  |  VISION_POSITION_ESTIMATE   |
  +-----------------------------+
</pre>
        </div>

        <h2>Detection Pipeline</h2>
        <div class="diagram">
<pre>
  Camera frame (1280x720 BGR, MJPG)
       |
       v
  cv2.cvtColor() --> Grayscale (3ms)
       |
       v
  CLAHE preprocessing (20ms)
    - clipLimit=2.5
    - tileGridSize=(8,8)
       |
       v
  cv2.aruco.detectMarkers() (250ms)
    - DICT_4X4_50
    - CORNER_REFINE_CONTOUR
       |
       v
  cv2.solvePnP() per marker
       |
       v
  DroneState(x, y, z, yaw, confidence)     [ENU frame]
       |
       v
  ENU to NED conversion --> VISION_POSITION_ESTIMATE
</pre>
        </div>

        <h2>Documentation</h2>
        <div class="cards">
            <div class="card">
                <h3>Debug Viewer</h3>
                <p>Manual frame capture with timing breakdown for debugging detection issues.</p>
                <a href="gui-guide.html">Read Guide &rarr;</a>
            </div>
            <div class="card">
                <h3>Camera Calibration</h3>
                <p>Calibrate your camera using ChArUco patterns for accurate pose estimation.</p>
                <a href="calibration.html">Read Guide &rarr;</a>
            </div>
            <div class="card">
                <h3>SITL Testing</h3>
                <p>Validate the full vision-to-FC pipeline against ArduCopter SITL without hardware.</p>
                <a href="sitl.html">Read Guide &rarr;</a>
            </div>
            <div class="card">
                <h3>FC Configuration</h3>
                <p>ArduCopter EKF3 and vision parameter setup for external navigation.</p>
                <a href="FC_CONFIG.md">Read Guide &rarr;</a>
            </div>
            <div class="card">
                <h3>Testing Guide</h3>
                <p>Complete testing procedures from bench tests to flight tests.</p>
                <a href="TESTING.md">Read Guide &rarr;</a>
            </div>
            <div class="card">
                <h3>Technical Details</h3>
                <p>Algorithms, coordinate frames, timing breakdown, and optimization.</p>
                <a href="TECHNICAL.md">Read Guide &rarr;</a>
            </div>
        </div>

        <h2>Tools</h2>
        <table>
            <tr>
                <th>Tool</th>
                <th>Description</th>
            </tr>
            <tr>
                <td><code>debug_viewer.py</code></td>
                <td><strong>Manual frame capture</strong> with timing breakdown (grab/gray/CLAHE/detect)</td>
            </tr>
            <tr>
                <td><code>test_sitl.py</code></td>
                <td>SITL validation - params, EKF origin, streaming, convergence, arm + flight</td>
            </tr>
            <tr>
                <td><code>generate_markers.py</code></td>
                <td>Create printable ArUco marker PDFs (18cm for A4)</td>
            </tr>
            <tr>
                <td><code>camera_server.py</code></td>
                <td>MJPEG streaming server (runs on RPi)</td>
            </tr>
            <tr>
                <td><code>calibrate_remote.py</code></td>
                <td>Network-based camera calibration</td>
            </tr>
            <tr>
                <td><code>calibrate_camera.py</code></td>
                <td>Local camera intrinsic calibration</td>
            </tr>
            <tr>
                <td><code>test_aruco_detection.py</code></td>
                <td>Live marker detection test</td>
            </tr>
            <tr>
                <td><code>test_mavlink.py</code></td>
                <td>MAVLink connection test</td>
            </tr>
            <tr>
                <td><code>generate_charuco.py</code></td>
                <td>Create ChArUco calibration boards</td>
            </tr>
        </table>

        <h2>SITL Validation Results</h2>
        <p>The full vision-to-FC pipeline has been validated in ArduCopter SITL:</p>
        <table>
            <tr>
                <th>Test</th>
                <th>Steps</th>
                <th>Result</th>
                <th>Position Error</th>
            </tr>
            <tr>
                <td>Basic (params + EKF convergence)</td>
                <td>6/6</td>
                <td style="color: #22c55e; font-weight: 600;">PASS</td>
                <td>0.004m</td>
            </tr>
            <tr>
                <td>Arm + guided flight (takeoff, hover, land)</td>
                <td>5/5</td>
                <td style="color: #22c55e; font-weight: 600;">PASS</td>
                <td>0.003m</td>
            </tr>
            <tr>
                <td>Circle pattern (1.5m radius, 20s)</td>
                <td>4/4</td>
                <td style="color: #22c55e; font-weight: 600;">PASS</td>
                <td>0.189m</td>
            </tr>
        </table>
        <p>See <a href="sitl.html">SITL Testing</a> for full details and reproduction steps.</p>

        <h2>Quick Start</h2>

        <h3>1. Generate and Print Markers</h3>
        <pre><code># Generate 18cm markers for A4 paper
python3 tools/generate_markers.py --ids 0,1,2,3 --size 180 -o markers/

# Print at 100% scale (no fit-to-page)</code></pre>

        <h3>2. Sync and Run on RPi</h3>
        <pre><code># Sync code to RPi
./sync_to_rpi.sh

# SSH to RPi
ssh aruconav@aruconav.local

# Run stream mode (HTTP server)
cd /home/aruconav/aruco_drone_nav
python3 -m src.main --mode stream</code></pre>

        <h3>3. Debug Viewer (Local Machine)</h3>
        <pre><code># Capture frames with timing
python3 tools/debug_viewer.py --host aruconav.local --port 8001

# Press SPACE to capture, shows:
# - Position, detection rate
# - Timing: grab/gray/CLAHE/bgr/detect/total</code></pre>

        <h3>4. Run Vision GPS</h3>
        <pre><code># Test mode (console output, no MAVLink)
python3 -m src.main --mode test

# Run mode (sends to FC)
python3 -m src.main --mode run</code></pre>

        <h2>Key Features</h2>
        <table>
            <tr>
                <th>Feature</th>
                <th>Description</th>
            </tr>
            <tr>
                <td>CLAHE Preprocessing</td>
                <td>Adaptive histogram equalization for robust detection in varying lighting</td>
            </tr>
            <tr>
                <td>Vision GPS Emulation</td>
                <td>Replaces GPS with ceiling-mounted ArUco markers for indoor flight</td>
            </tr>
            <tr>
                <td>Timing Instrumentation</td>
                <td>Detailed breakdown of processing time (grab/gray/CLAHE/detect)</td>
            </tr>
            <tr>
                <td>6-DOF Pose Estimation</td>
                <td>Full position and orientation via solvePnP with calibrated camera</td>
            </tr>
            <tr>
                <td>EKF3 Integration</td>
                <td>FC uses vision data as primary position source via ExternalNav</td>
            </tr>
            <tr>
                <td>SITL Validated</td>
                <td>Full pipeline tested: arm, takeoff, hover, land, circle pattern</td>
            </tr>
            <tr>
                <td>HTTP Streaming</td>
                <td>Position + timing data via JSON endpoint for remote debugging</td>
            </tr>
        </table>

        <h2>Hardware Requirements</h2>
        <ul>
            <li><strong>Companion Computer:</strong> Raspberry Pi Zero 2W</li>
            <li><strong>Camera:</strong> USB camera with MJPG support (1280x720 @ 30fps)</li>
            <li><strong>Flight Controller:</strong> ArduCopter-compatible (Pixhawk, etc.)</li>
            <li><strong>Markers:</strong> Printed ArUco markers (DICT_4X4_50, 18cm on A4)</li>
            <li><strong>Connection:</strong> UART serial @ 921600 baud</li>
        </ul>

        <div class="note">
            <strong>Note:</strong> The system achieves 95-100% detection rate at ~3.7 FPS on RPi Zero 2W at 1280x720. CLAHE preprocessing provides robust detection in varying lighting conditions.
        </div>

        <h2>Project Status</h2>
        <p>Current version: <strong>1.2</strong> (2026-02-04)</p>
        <ul>
            <li>Single ArUco markers with CLAHE preprocessing</li>
            <li>95-100% detection rate achieved</li>
            <li>Timing instrumentation for performance analysis</li>
            <li>HTTP streaming with debug viewer</li>
            <li>SITL: Full pipeline validated</li>
            <li>Next: FPS optimization (3.7 â†’ 10+ FPS)</li>
        </ul>
    </main>

    <footer>
        <p>ArUco Vision GPS &copy; 2026 Warsaw University of Technology</p>
        <p>Authors: Adam Koszalka &amp; Claude Code</p>
    </footer>
</body>
</html>
