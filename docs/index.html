<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArUco Vision GPS - Documentation</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav>
        <div class="container">
            <a href="index.html" class="logo">ArUco<span>Nav</span></a>
            <ul>
                <li><a href="index.html" class="active">Home</a></li>
                <li><a href="calibration.html">Calibration</a></li>
                <li><a href="sitl.html">SITL Testing</a></li>
                <li><a href="https://github.com/asdfgh0318/aruco_drone_nav">GitHub</a></li>
            </ul>
        </div>
    </nav>

    <div class="hero">
        <h1>ArUco Vision GPS</h1>
        <p>Vision-based GPS emulator for indoor drones using ceiling-mounted ArUco markers on Raspberry Pi Zero 2W</p>
    </div>

    <main>
        <h2>Overview</h2>
        <p>A minimal Python system (~490 lines) that detects ceiling-mounted ArUco markers, calculates world-frame position, and sends <code>VISION_POSITION_ESTIMATE</code> to an ArduCopter flight controller via MAVLink. The FC handles all navigation, PID control, missions, and failsafes natively.</p>

        <img src="images/detection_live.jpg" alt="Live camera view from RPi Zero 2W showing ArUco marker detection on ceiling" class="screenshot">
        <p><em>Live camera view from RPi Zero 2W - ArUco marker ID 0 on ceiling at ~1.7m distance</em></p>

        <h2>Current Performance (RPi Zero 2W)</h2>
        <table>
            <tr>
                <th>Metric</th>
                <th>Value</th>
            </tr>
            <tr>
                <td>Resolution</td>
                <td>1280x720 (MJPG)</td>
            </tr>
            <tr>
                <td>Detection Rate</td>
                <td>99-100%</td>
            </tr>
            <tr>
                <td>Processing Time</td>
                <td>~140ms/frame</td>
            </tr>
            <tr>
                <td>FPS</td>
                <td>~6</td>
            </tr>
            <tr>
                <td>Marker Type</td>
                <td>Single ArUco (DICT_4X4_50)</td>
            </tr>
            <tr>
                <td>Marker Size</td>
                <td>18cm (A4 printable)</td>
            </tr>
            <tr>
                <td>Working Distance</td>
                <td>1.5-2.5m</td>
            </tr>
            <tr>
                <td>Source Code</td>
                <td>~490 lines (2 files)</td>
            </tr>
        </table>

        <h3>Timing Breakdown</h3>
        <pre><code>gray:3ms  CLAHE:20ms  bgr:2ms  detect:110ms  total:135ms</code></pre>

        <h2>System Architecture</h2>
        <div class="diagram">
<pre>
  Ceiling
  [Marker 0] [Marker 1] [Marker 2] ...    (known world positions)
       |          |          |
       v          v          v
  +-----------------------------+          +---------------------+
  | RPi Zero 2W                 |          | Flight Controller   |
  |                             |          | ArduCopter          |
  |  USB Camera (1280x720 MJPG) |          |                     |
  |       |                     |          | EKF3                |
  |       v                     |          |  - ExternalNav src  |
  |  CLAHE Preprocessing        |          |  - Baro for alt     |
  |       |                     |          |                     |
  |       v                     |  UART   | PID / Navigation    |
  |  ArUco Detection            | -------> | Missions / RTL      |
  |  - detectMarkers()          | MAVLink  | Failsafes           |
  |  - solvePnP per marker      |          +---------------------+
  |       |                     |
  |       v                     |
  |  Position Estimation        |
  |  - marker-to-world transform|
  |  - ENU to NED conversion    |
  |       |                     |
  |       v                     |
  |  VISION_POSITION_ESTIMATE   |
  +-----------------------------+
</pre>
        </div>

        <h2>Detection Pipeline</h2>
        <div class="diagram">
<pre>
  Camera frame (1280x720 BGR, MJPG)
       |
       v
  cv2.cvtColor() --> Grayscale (3ms)
       |
       v
  CLAHE preprocessing (20ms)
    - clipLimit=2.5
    - tileGridSize=(8,8)
       |
       v
  cv2.aruco.detectMarkers() (110ms)
    - DICT_4X4_50
    - CORNER_REFINE_CONTOUR
       |
       v
  cv2.solvePnP() per marker
       |
       v
  DroneState(x, y, z, yaw, confidence)     [ENU frame]
       |
       v
  ENU to NED conversion --> VISION_POSITION_ESTIMATE
</pre>
        </div>

        <h2>Source Files</h2>
        <table>
            <tr>
                <th>File</th>
                <th>Lines</th>
                <th>Purpose</th>
            </tr>
            <tr>
                <td><code>src/vision_gps.py</code></td>
                <td>~393</td>
                <td>Camera, detection, position estimation, HTTP server, main loop</td>
            </tr>
            <tr>
                <td><code>src/mavlink_bridge.py</code></td>
                <td>~97</td>
                <td>MAVLink connection, send vision position, set EKF origin</td>
            </tr>
            <tr>
                <td><code>src/__main__.py</code></td>
                <td>3</td>
                <td>Entry point (<code>python3 -m src</code>)</td>
            </tr>
        </table>

        <h2>Documentation</h2>
        <div class="cards">
            <div class="card">
                <h3>Wiring Guide</h3>
                <p>RPi Zero 2W + SpeedyBee F405 V3 UART wiring and FC parameter setup.</p>
                <a href="WIRING.md">Read Guide &rarr;</a>
            </div>
            <div class="card">
                <h3>Camera Calibration</h3>
                <p>Calibrate your camera using ChArUco patterns for accurate pose estimation.</p>
                <a href="calibration.html">Read Guide &rarr;</a>
            </div>
            <div class="card">
                <h3>SITL Testing</h3>
                <p>Validate the full vision-to-FC pipeline against ArduCopter SITL without hardware.</p>
                <a href="sitl.html">Read Guide &rarr;</a>
            </div>
            <div class="card">
                <h3>FC Configuration</h3>
                <p>ArduCopter EKF3 and vision parameter setup for external navigation.</p>
                <a href="FC_CONFIG.md">Read Guide &rarr;</a>
            </div>
            <div class="card">
                <h3>Testing Guide</h3>
                <p>Complete testing procedures from bench tests to flight tests.</p>
                <a href="TESTING.md">Read Guide &rarr;</a>
            </div>
            <div class="card">
                <h3>Technical Details</h3>
                <p>Algorithms, coordinate frames, timing breakdown, and optimization.</p>
                <a href="TECHNICAL.md">Read Guide &rarr;</a>
            </div>
        </div>

        <h2>Tools</h2>
        <table>
            <tr>
                <th>Tool</th>
                <th>Description</th>
            </tr>
            <tr>
                <td><code>debug_viewer.py</code></td>
                <td>Remote frame capture with timing breakdown from HTTP stream</td>
            </tr>
            <tr>
                <td><code>test_sitl.py</code></td>
                <td>SITL validation - params, EKF origin, streaming, convergence, arm + flight</td>
            </tr>
            <tr>
                <td><code>generate_markers.py</code></td>
                <td>Create printable ArUco marker PDFs (18cm for A4)</td>
            </tr>
            <tr>
                <td><code>camera_server.py</code></td>
                <td>MJPEG streaming server (runs on RPi)</td>
            </tr>
            <tr>
                <td><code>calibrate_remote.py</code></td>
                <td>Network-based camera calibration</td>
            </tr>
            <tr>
                <td><code>calibrate_camera.py</code></td>
                <td>Local camera intrinsic calibration</td>
            </tr>
        </table>

        <h2>SITL Validation Results</h2>
        <p>The full vision-to-FC pipeline has been validated in ArduCopter SITL:</p>
        <table>
            <tr>
                <th>Test</th>
                <th>Steps</th>
                <th>Result</th>
                <th>Position Error</th>
            </tr>
            <tr>
                <td>Basic (params + EKF convergence)</td>
                <td>6/6</td>
                <td style="color: #22c55e; font-weight: 600;">PASS</td>
                <td>0.004m</td>
            </tr>
            <tr>
                <td>Arm + guided flight (takeoff, hover, land)</td>
                <td>5/5</td>
                <td style="color: #22c55e; font-weight: 600;">PASS</td>
                <td>0.003m</td>
            </tr>
            <tr>
                <td>Circle pattern (1.5m radius, 20s)</td>
                <td>4/4</td>
                <td style="color: #22c55e; font-weight: 600;">PASS</td>
                <td>0.189m</td>
            </tr>
        </table>
        <p>See <a href="sitl.html">SITL Testing</a> for full details and reproduction steps.</p>

        <h2>Quick Start</h2>

        <h3>1. Generate and Print Markers</h3>
        <pre><code># Generate 18cm markers for A4 paper
python3 tools/generate_markers.py --ids 0,1,2,3 --size 180 -o markers/

# Print at 100% scale (no fit-to-page)</code></pre>

        <h3>2. Sync and Run on RPi</h3>
        <pre><code># Sync code to RPi
./sync_to_rpi.sh

# SSH to RPi
ssh aruconav@aruconav.local

# Run stream mode (HTTP server)
cd /home/aruconav/aruco_drone_nav
python3 -m src --mode stream --port 8001</code></pre>

        <h3>3. Monitor (Local Machine)</h3>
        <pre><code># Check position via HTTP
curl http://aruconav.local:8001/position

# Debug viewer with live frames
python3 tools/debug_viewer.py --host aruconav.local --port 8001</code></pre>

        <h3>4. Run Vision GPS</h3>
        <pre><code># Test mode (console output, no MAVLink)
python3 -m src --mode test

# Run mode (sends to FC via MAVLink)
python3 -m src --mode run</code></pre>

        <h3>Sample JSON Output</h3>
        <pre><code>{
  "x": 0.549, "y": -0.289, "z": 1.712,
  "yaw": 159.2, "marker_ids": ["0"], "confidence": 1.0,
  "detection_rate": 1.0, "uptime": 10.4,
  "timing": {"gray": "5", "clahe": "21", "detect": "107", "total": "134"}
}</code></pre>

        <h2>FC Configuration (ArduCopter)</h2>
        <table>
            <tr><th>Parameter</th><th>Value</th><th>Purpose</th></tr>
            <tr><td><code>AHRS_EKF_TYPE</code></td><td>3</td><td>Use EKF3</td></tr>
            <tr><td><code>EK3_SRC1_POSXY</code></td><td>6</td><td>ExternalNav for XY position</td></tr>
            <tr><td><code>EK3_SRC1_POSZ</code></td><td>1</td><td>Baro for altitude (safer indoors)</td></tr>
            <tr><td><code>EK3_SRC1_YAW</code></td><td>6</td><td>ExternalNav for yaw</td></tr>
            <tr><td><code>VISO_TYPE</code></td><td>1</td><td>MAVLink vision input</td></tr>
            <tr><td><code>GPS_TYPE</code></td><td>0</td><td>Disable GPS (indoor)</td></tr>
            <tr><td><code>COMPASS_ENABLE</code></td><td>0</td><td>Disable compass (indoor)</td></tr>
        </table>
        <p>See <a href="FC_CONFIG.md">FC_CONFIG.md</a> for full parameter list and tuning guide.</p>

        <h2>Hardware Requirements</h2>
        <ul>
            <li><strong>Companion Computer:</strong> Raspberry Pi Zero 2W</li>
            <li><strong>Camera:</strong> USB camera with MJPG support (1280x720 @ 30fps)</li>
            <li><strong>Flight Controller:</strong> ArduCopter-compatible (Pixhawk, etc.)</li>
            <li><strong>Markers:</strong> Printed ArUco markers (DICT_4X4_50, 18cm on A4)</li>
            <li><strong>Connection:</strong> UART serial @ 921600 baud</li>
        </ul>

        <div class="note">
            <strong>Status:</strong> Vision system tested on RPi Zero 2W with 99-100% detection at ~6 FPS. Next step: real drone hardware testing.
        </div>

        <h2>Project Status</h2>
        <p>Current version: <strong>2.0</strong> (2026-02-09)</p>
        <ul>
            <li>Codebase minimized from 3,329 to ~490 lines</li>
            <li>99-100% detection rate at ~6 FPS (~140ms/frame)</li>
            <li>CLAHE preprocessing for robust lighting adaptation</li>
            <li>HTTP streaming with JSON position + JPEG debug frames</li>
            <li>SITL: Full pipeline validated (arm, takeoff, hover, land, circle)</li>
            <li>Next: Real drone hardware testing</li>
        </ul>
    </main>

    <footer>
        <p>ArUco Vision GPS &copy; 2026 Warsaw University of Technology</p>
        <p>Authors: Adam Koszalka &amp; Claude Code</p>
    </footer>
</body>
</html>
