<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SITL Testing - ArUco Vision GPS</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav>
        <div class="container">
            <a href="index.html" class="logo">ArUco<span>Nav</span></a>
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="gui-guide.html">Debug GUI</a></li>
                <li><a href="calibration.html">Calibration</a></li>
                <li><a href="sitl.html" class="active">SITL Testing</a></li>
                <li><a href="https://github.com/asdfgh0318/aruco_drone_nav">GitHub</a></li>
            </ul>
        </div>
    </nav>

    <main>
        <h1>SITL Testing Guide</h1>
        <p>Validate the full vision-to-FC MAVLink pipeline against ArduCopter SITL without any hardware. The SITL tool connects to a simulated flight controller, sets vision parameters, streams synthetic position data, and verifies EKF convergence.</p>

        <h2>Prerequisites</h2>

        <h3>Build ArduCopter SITL</h3>
        <pre><code># Clone ArduPilot (one-time)
git clone --recurse-submodules https://github.com/ArduPilot/ardupilot.git ~/ardupilot

# Install dependencies (Ubuntu/Debian)
cd ~/ardupilot && Tools/environment_install/install-prereqs-ubuntu.sh -y

# Build SITL
./waf configure --board sitl && ./waf build --target bin/arducopter</code></pre>

        <h3>Vision Parameters</h3>
        <p>The project includes a parameter file (<code>config/sitl_params.parm</code>) that configures the FC for vision-based navigation:</p>
        <table>
            <tr><th>Parameter</th><th>Value</th><th>Purpose</th></tr>
            <tr><td><code>AHRS_EKF_TYPE</code></td><td>3</td><td>Use EKF3</td></tr>
            <tr><td><code>EK3_SRC1_POSXY</code></td><td>6</td><td>ExternalNav for XY position</td></tr>
            <tr><td><code>EK3_SRC1_POSZ</code></td><td>1</td><td>Baro for altitude (safer)</td></tr>
            <tr><td><code>EK3_SRC1_YAW</code></td><td>6</td><td>ExternalNav for yaw</td></tr>
            <tr><td><code>VISO_TYPE</code></td><td>1</td><td>MAVLink vision input</td></tr>
            <tr><td><code>VISO_POS_M_NSE</code></td><td>0.2</td><td>Position noise (meters)</td></tr>
            <tr><td><code>VISO_YAW_M_NSE</code></td><td>0.3</td><td>Yaw noise (radians)</td></tr>
            <tr><td><code>GPS_TYPE</code></td><td>0</td><td>Disable GPS</td></tr>
            <tr><td><code>COMPASS_ENABLE</code></td><td>0</td><td>Disable compass</td></tr>
        </table>

        <h2>Starting SITL</h2>

        <h3>Option A: Raw Binary (Recommended)</h3>
        <pre><code>cd /tmp && ~/ardupilot/build/sitl/bin/arducopter \
    --model + --speedup 1 -I0 \
    --home 52.2297,21.0122,100,0 \
    --defaults ~/ardupilot/Tools/autotest/default_params/copter.parm,/path/to/config/sitl_params.parm</code></pre>
        <p>This pre-loads vision parameters so no reboot is needed.</p>

        <h3>Option B: sim_vehicle.py (if MAVProxy installed)</h3>
        <pre><code>sim_vehicle.py -v ArduCopter \
    --add-param-file config/sitl_params.parm \
    --console --map</code></pre>

        <div class="note">
            <strong>Connection:</strong> Raw SITL binary listens on <code>tcp:127.0.0.1:5760</code>. sim_vehicle.py uses <code>udp:127.0.0.1:14550</code>.
        </div>

        <h2>Running Validation</h2>

        <h3>Basic Validation (EKF Convergence)</h3>
        <pre><code>python3 tools/test_sitl.py -v --skip-params</code></pre>
        <p>Steps: Connect &rarr; Set EKF origin &rarr; Stream vision data (15s @ 20Hz) &rarr; Check EKF convergence</p>

        <h3>Arm + Guided Flight</h3>
        <pre><code>python3 tools/test_sitl.py -v --skip-params --arm</code></pre>
        <p>Additional steps: Set GUIDED mode &rarr; Arm &rarr; Takeoff to 2m &rarr; Hover &rarr; Land &rarr; Disarm</p>

        <h3>Circle Pattern</h3>
        <pre><code>python3 tools/test_sitl.py -v --skip-params -p circle -d 20</code></pre>
        <p>Streams a 1.5m radius circle at 10s period with yaw rotation. Tests dynamic tracking.</p>

        <h3>All Options</h3>
        <table>
            <tr><th>Flag</th><th>Default</th><th>Description</th></tr>
            <tr><td><code>-c, --connection</code></td><td><code>tcp:127.0.0.1:5760</code></td><td>MAVLink connection string</td></tr>
            <tr><td><code>-p, --pattern</code></td><td><code>hover</code></td><td>Position pattern: hover, square, circle</td></tr>
            <tr><td><code>-d, --duration</code></td><td><code>15</code></td><td>Stream duration (seconds)</td></tr>
            <tr><td><code>--arm</code></td><td>off</td><td>Attempt arm + guided flight</td></tr>
            <tr><td><code>--skip-params</code></td><td>off</td><td>Skip param setting (use pre-configured SITL)</td></tr>
            <tr><td><code>-v, --verbose</code></td><td>off</td><td>Verbose debug logging</td></tr>
        </table>

        <h2>Validation Results</h2>

        <h3>Test 1: Basic 6-Step Validation</h3>
        <div class="diagram">
<pre>
==================================================
       SITL VALIDATION
==================================================
  Connection:  tcp:127.0.0.1:5760
  Pattern:     hover
  Duration:    15.0s
  Skip params: False
  Arm flight:  False

  Connect to SITL                      [PASS]
  Set FC parameters                    [PASS]
  Reboot &amp; reconnect                   [PASS]
  Set EKF origin                       [PASS]
  Stream vision data (15s)             [PASS]
  Check EKF convergence                [PASS]

  Result: 6/6 PASSED
</pre>
        </div>
        <p>EKF converged with <strong>0.004m</strong> position error. FC confirmed: <em>"EKF3 IMU0 is using external nav data"</em></p>

        <h3>Test 2: Arm + Guided Flight</h3>
        <div class="diagram">
<pre>
  Connect to SITL                      [PASS]
  Set EKF origin                       [PASS]
  Stream vision data (15s)             [PASS]
  Check EKF convergence                [PASS]
  Arm + guided flight                  [PASS]

  Result: 5/5 PASSED
</pre>
        </div>
        <p>Vehicle armed in GUIDED mode, took off to 2m, hovered at 1.86m, landed at 0.49 m/s, disarmed cleanly. Position error: <strong>0.003m</strong></p>

        <h3>Test 3: Circle Pattern</h3>
        <div class="diagram">
<pre>
  Connect to SITL                      [PASS]
  Set EKF origin                       [PASS]
  Stream vision data (20s)             [PASS]
  Check EKF convergence                [PASS]

  Result: 4/4 PASSED
</pre>
        </div>
        <p>1.5m radius circle, 10s period, with yaw rotation. 400 messages at 20Hz. Position error: <strong>0.189m</strong></p>

        <h3>Summary</h3>
        <table>
            <tr>
                <th>Test</th>
                <th>Steps</th>
                <th>Result</th>
                <th>Position Error</th>
            </tr>
            <tr>
                <td>Basic (params + EKF convergence)</td>
                <td>6/6</td>
                <td style="color: #22c55e; font-weight: 600;">PASS</td>
                <td>0.004m</td>
            </tr>
            <tr>
                <td>Arm + guided flight</td>
                <td>5/5</td>
                <td style="color: #22c55e; font-weight: 600;">PASS</td>
                <td>0.003m</td>
            </tr>
            <tr>
                <td>Circle pattern (1.5m, 20s)</td>
                <td>4/4</td>
                <td style="color: #22c55e; font-weight: 600;">PASS</td>
                <td>0.189m</td>
            </tr>
        </table>

        <h2>Troubleshooting</h2>

        <h3>TCP Reconnect After Reboot</h3>
        <div class="warning">
            <strong>Known issue:</strong> SITL's TCP socket does not survive a soft reboot. If you use <code>test_sitl.py</code> without <code>--skip-params</code>, the reboot step may fail. Solution: start SITL with <code>--defaults</code> to pre-load params, then use <code>--skip-params</code>.
        </div>

        <h3>EKF Divergence After Arm Test</h3>
        <p>After an arm+flight test, the EKF retains stale state. Restart SITL for a clean convergence test.</p>

        <h3>No Heartbeat</h3>
        <ul>
            <li>Verify SITL is running: <code>ss -tlnp | grep 5760</code></li>
            <li>Check connection string matches SITL's listen port</li>
            <li>Raw binary uses TCP 5760, sim_vehicle.py uses UDP 14550</li>
        </ul>

        <h3>Pre-arm Failures</h3>
        <ul>
            <li>Ensure EKF origin is set before arming</li>
            <li>Stream vision data for at least 10s before attempting arm</li>
            <li>Check FC status messages with <code>-v</code> flag</li>
        </ul>

        <div class="tip">
            <strong>Recommended workflow:</strong> Start SITL with pre-configured params, then run tests with <code>--skip-params</code>. This avoids the TCP reconnect issue entirely.
        </div>
    </main>

    <footer>
        <p>ArUco Vision GPS &copy; 2026 Warsaw University of Technology</p>
        <p>Authors: Adam Koszalka &amp; Claude Code</p>
    </footer>
</body>
</html>
